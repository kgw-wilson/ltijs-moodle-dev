# ltijs TypeScript Monorepo with Moodle for Local Development

## Intro

This repository contains an early version of a local development environment for an LTI tool called Gradebotics. Although active development has been discontinued, the project is shared to help make LTI tool development easier and more approachable for others.

This setup was inspired by the excellent work of the [ltijs](https://github.com/Cvmcosta/ltijs)
project and various open-source TypeScript monorepo examples.

What makes this repository unique includes:

•	Local browser-based development (rather than using a VNC-based setup such as Fluxbox)

•	Centralized data storage using a single PostgreSQL database

•	Monorepo structure using pnpm, enabling shared packages for platform code

The goal was to create a streamlined, developer-friendly environment for building and testing LTI tools locally with Moodle.

This project is provided as-is and may serve best as a reference or starting point rather than a production-ready solution.

If you have questions, suggestions, or notice any issues, feel free to open an issue — feedback is welcome.

All code in this repository is released under the MIT License and is free for commercial and non-commercial use.

## Description

This repo supports running a demo in which moodle is configured to launch an external tool via LTI 1.3. The tool uses ltijs for LTI support. Moodle was chosen because it's lightweight and it's easier to have deployed instances of other LMS's for cross-platform compatibility testing.

Running this demo requires docker.

Note that all shell scripts and docker commands are to be executed locally (on the docker host), and all browser operations are to be performed in your normal development computer's browser.

These docker containers are used for local development.

1. moodle - the open-source LMS (learning management system)
2. gradebotics - our LTI-launchable tool that relies on ltijs for LTI support
3. postgresql - the backing database used by our platform and moodle
4. traefik - reverse proxy
5. adminer - lightweight database management tool for PostgreSQL

## Toolchain

Docker & Docker Desktop

git CLI & Github ssh keys (to clone repo)

node version v22.14.0 from nvm

pnpm: npm install -g pnpm@10.9.0


## Trust Local HTTPS for Development

This project uses locally trusted HTTPS certificates so you can access https://gradebotics.localhost and others without security warnings.

On macOS, run from repo root:

```
brew install mkcert
mkcert -install

mkcert -key-file local-dev/certs/local.key -cert-file local-dev/certs/local.crt \
 traefik.localhost moodle.localhost gradebotics.localhost adminer.localhost

echo "# Gradebotics local dev\n127.0.0.1 traefik.localhost moodle.localhost gradebotics.localhost adminer.localhost" | sudo tee -a /etc/hosts

cp "$(mkcert -CAROOT)/rootCA.pem" ./local-dev/certs/
```

This installs mkcert, generates trusted certs for the containers' local domains, and updates your /etc/hosts file. This allows you to visit urls like https://traefik.localhost in your browser and trust their security.

The last line copies your local root certificate authority (created by mkcert) into a common location that then gets copied into our gradebotics container when it is built. This allows Node.js in the gradebotics container to trust HTTPS connections to local domains like moodle.localhost.

## Traefik & Checking Container Status

Traefik is used as a reverse proxy and dynamic router to expose services running in Docker (with HTTPS support and a built-in dashboard for easier debugging), making local development accessible through a normal browser with trusted certificates.

You can go to https://traefik.localhost to see a dashboard that's useful for seeing the statuses of which services are running and on which ports.

Another useful tool is: `docker network inspect local-dev_web`.

## Startup

The script startup.sh will create and start all containers. This will take several minutes the first time you do it but should just take a few seconds on subsequent startups.


```
./local-dev/startup.sh
```

This will generate a lot of logs. If you want to isolate logs generated by just one container, (for instance moodle), you can do this in an another terminal window: 

```
docker logs -f moodle
```

Startup is complete when you see the following log output from the moodle container:

```
[Tue Jul 14 23:08:14.624469 2020] [mpm_prefork:notice] [pid 74] AH00163: Apache/2.4.43 (Unix) OpenSSL/1.1.1d PHP/7.3.19 configured -- resuming normal operations
[Tue Jul 14 23:08:14.624532 2020] [core:notice] [pid 74] AH00094: Command line: 'httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND'
```

## Login to moodle

* Visit https://moodle.localhost in your browser to connect to the moodle
* Make sure you have enabled cookies (the LTI 1.3 protocol relies on cookies)
* Click the login link in the upper right
* Login with username: "user", and password: "bitnami"

## Configure Gradebotics as an external tool

* Click on "Site administration" in the navigation header
* Click on the "Plugins" tab
* Under "Activity Modules", click on "Manage Tools"
* Type in "https://gradebotics.localhost/lti/register" to the input box
* Click "Add LTI Advantage"
* Click "Activate" on the "Gradebotics" card that appeared.

## Add the tool to a moodle course

* Click on "My Courses" in the navigation header
* Click the toggle in the top-right of the screen to turn on editing
* Click "Add a new course"
* Type in required details like "Testing" for "Course full name" and "Test" for "Course short name"
* Scroll down and click "Save and display"
* Click "More" and from the dropdown select "LTI External Tools"
* Toggle "Show in activity chooser"
* Click "Course"
* Click on the "+" in any of the content blocks and then click "Activity or resource"
* Select "Gradebotics"
* Enter "Gradebotics" for "Activity name"
* Scroll down and click "Save and return to course"
* Click the toggle in the top-right of the screen to turn on editing

## Launch the tool

* Click on "Gradebotics"
* If everything worked correctly, you should see our platform's frontend code loaded

## Access PostgreSQL data

The local dev setup includes adminer, a lightweight tool for inspecting postgres data. 

* Visit https://adminer.localhost in your browser
* For "System" select "PostgreSQL"
* For "Server" type "postgresql" (same name as our service in the docker network)
* For "Username" type "postgres" (username for default superuser with access to all databases)
* For "Password" type "password123" (password for superuser set in docker-compose.yml)
* For "Database" type "bitnami_moodle" (database names are declared in postgresql-initdb.d/init.sql)
* Press "Login"
* Select "SQL command" from the pane on the left
* Type in "SELECT * FROM mdl_course"
* Press "Execute"
* Your results should show the course you created on the moodle site, for instance with fullname "Testing" and shortname "Test".
* Switch to see our application tables by selecting the "DB" dropdown on the left and selecting "gradebotics" 
* Click "select" next to "idtokens" and you should see a row with "iss" "https://moodle.localhost"

## Shutdown

Stop the containers by simply typing control+C in your terminal. To stop and remove all containers use:

```
docker compose -f local-dev/docker-compose.yml down
```

You can also add -v to the end if you want to remove associated volumes (for instance to trigger a fresh DB init next time).

## Cleanup

Note that because the data directories of moodle, mariadb, and mongodb are mounted from local directories, the moodle and LTI configurations are persistent. If you want to start over from scratch, then run the cleanup.sh script `./local-dev/cleanup.sh`.

## Troubleshooting

If you've deleted and re-added the external tool using the Admin External Tools UI, keep in mind that you will also need to delete and re-add the tool from the dashboard.

If you have trouble starting the moodle container after a cleanup (failing on `Running Moodle install script`) you may need to do a shutdown, a cleanup, and a fresh restart. Changing things like the database-related variables might cause problems that can be fixed this way.
